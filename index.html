<html>
  <head>
    <title>Geometry Generation</title>
  </head>

  <style>
  body {margin: 0;}
  canvas {width: 100%; height: 100%;}
  </style>

  <body>
	<link rel="shortcut icon" href="#">
   
    <style>
    			body {
    				font-family: sans-serif;
    				background-color: #000000;
    				color: #ffffff;
    				margin: 0px;
    				overflow: hidden;
    			}
    			#info {
    				position: absolute;
    				top: 10px;
    				width: 100%;
    				text-align: center;
    			}
    </style>

    <div id="info">
      <p>Computer Graphics Group Assessment</p>
	  <p>Garden Generator</p>
	  <p>space to walk around</p>
    </div>

		<script type="importmap">
			{
				"imports": {
					"three": "../build/three.module.js"
				}
			}
		</script>

	  <script type="module">

	//setting the scene
	import * as THREE from 'three';
	import { PointerLockControls } from './build/controls/PointerLockControls.js';
	import { GUI } from "https://cdn.skypack.dev/dat.gui";
	import { GLTFLoader } from './build/loaders/GLTFLoader.js';
	import { OrbitControls } from './build/controls/OrbitControls.js';



	var scene = new THREE.Scene();
	var width = window.innerWidth;
	var height = window.innerHeight;
	const camera = new THREE.PerspectiveCamera(45, width/height,1,1000);
	scene.add(camera);
	camera.position.set(0,4,18);

	scene.background = new THREE.Color( 0xa0a0a0 );
	//scene.fog = new THREE.Fog( 0xa0a0a0, 40, 40 ); //for night

	var renderer = new THREE.WebGLRenderer();
	renderer.setSize(window.innerWidth, window.innerHeight);

	document.body.appendChild(renderer.domElement);

	//TEXTURES

	const texture = new THREE.TextureLoader();
	texture.wrapS = THREE.RepeatWrapping;
	texture.wrapT = THREE.RepeatWrapping;
	const colorTex = texture.load('textures/bestgrass/Grass004_4K-JPG_Color.jpg');
	const dispTex = texture.load('textures/bestgrass/Grass004_4K-JPG_Displacement.jpg');
	const nrmTex = texture.load('textures/bestgrass/Grass004_4K-JPG_NormalDX.jpg');
	const occTex = texture.load('textures/bestgrass/Grass004_4K-JPG_AmbientOcclusion.jpg');
	const roughTex = texture.load('textures/bestgrass/Grass004_4K-JPG_Roughness.jpg');
	const basegeo = new THREE.PlaneGeometry(20,20);
	const basemat = new THREE.MeshStandardMaterial({
		map: colorTex,
		normalMap: nrmTex,
		displacementMap: dispTex,
		roughnessMap: roughTex,
		aoMap: occTex
	});

	const base = new THREE.Mesh(basegeo, basemat);
	base.rotation.x = -Math.PI / 2;
	scene.add( base );

	const colorTexS = texture.load('textures/path/PavingStones138_4K-JPG_Color.jpg');
	const dispTexS = texture.load('textures/path/PavingStones138_4K-JPG_Displacement.jpg');
	const nrmTexS = texture.load('textures/path/PavingStones138_4K-JPG_NormalDX.jpg');
	const occTexS = texture.load('textures/path/PavingStones138_4K-JPG_AmbientOcclusion.jpg');
	const roughTexS = texture.load('textures/path/PavingStones138_4K-JPG_Roughness.jpg');
	const pathgeoS = new THREE.PlaneGeometry(26.5,26.5);
	const pathmatS = new THREE.MeshStandardMaterial({
		map: colorTexS,
		normalMap: nrmTexS,
		displacementMap: dispTexS,
		roughnessMap: roughTexS,
		aoMap: occTexS
	});

	const path = new THREE.Mesh(pathgeoS, pathmatS);
	path.rotation.x = -Math.PI / 2;
	path.position.y = -0.1;
	scene.add( path );

	const colorTexD = texture.load('textures/dirt/Ground048_4K-JPG_Color.jpg');
	const dispTexD = texture.load('textures/dirt/Ground048_4K-JPG_Displacement.jpg');
	const nrmTexD = texture.load('textures/dirt/Ground048_4K-JPG_NormalDX.jpg');
	const occTexD = texture.load('textures/dirt/Ground048_4K-JPG_AmbientOcclusion.jpg');
	const roughTexD = texture.load('textures/dirt/Ground048_4K-JPG_Roughness.jpg');
	const dirtgeoD = new THREE.PlaneGeometry(35,35);
	const dirtmatD = new THREE.MeshStandardMaterial({
		map: colorTexD,
		normalMap: nrmTexD,
		displacementMap: dispTexD,
		roughnessMap: roughTexD,
		aoMap: occTexD
	});

	const dirt = new THREE.Mesh(dirtgeoD, dirtmatD);
	dirt.rotation.x = -Math.PI / 2;
	dirt.position.y = -0.2;
	//dirt.position.x = 6.5;
	scene.add( dirt );

	const orbcontrols = new OrbitControls(camera, renderer.domElement);

	//TREE MOVINGS

	var trees = [];
	var tree;

	const loaderT = new GLTFLoader().setPath('jungle_tree/');
	loaderT.load('scene.gltf', (gltf) => {
		tree = gltf.scene;
		scene.add(tree);
		tree.position.x = -1;
		trees.push(tree);
	})

	var raycaster = new THREE.Raycaster();
	var treeSelected = false;

	function onDocumentMouseDown (event){
		var mouse = new THREE.Vector2;
		mouse.x = ( event.clientX / renderer.domElement.clientWidth ) * 2 - 1;
		mouse.y = - ( event.clientY / renderer.domElement.clientHeight ) * 2 + 1;
		raycaster.setFromCamera( mouse, camera );

		var intersects = raycaster.intersectObject(tree);

		if(intersects.length > 0){
			console.log("CLICKED TREE");
			if(!treeSelected){
				treeSelected = true;
			}
		}

		if(treeSelected){
			var intersects2 = raycaster.intersectObject(base);
			if(intersects2.length > 0){
				console.log("CLICKED BASE");

				var pos=intersects2[0].point;
				console.log("Placed!");
				tree.position.x=pos.x;
				tree.position.z=pos.z;
				treeSelected = false;
			}
		}
	}

	document.addEventListener('mousedown', onDocumentMouseDown, false);

	/*
	const loaderF = new GLTFLoader().setPath('old_fence/');
	loaderF.load('scene.gltf', (gltf) => {
		const fence = gltf.scene;
		scene.add(fence);
		fence.scale.set(0.05, 0.05, 0.05);
		//fence.rotation.y = 45.1;
		fence.position.x = (-7);
		fence.position.set(-7,0.1,-17.5);
	})*/

	//GRASS GENERATION

	var grassTotal = 0; //total grass
	var grasses = []; //array of grass in the scene

	var addGrass = function(){
		const loader = new GLTFLoader().setPath('realistics_grass_03/');
		loader.load('scene.gltf', (gltf) => {
			const grass = gltf.scene;
			scene.add(grass);
			var posx = Math.random() * 16 - 8;
			var posy = Math.random() * 18 - 9;
			grass.position.set(posx,0.25,posy);
			grasses.push(grass);
		})
	}

	//randomise grass & handles adding/removing them
	var grassRandomiser = function(){
		if(params.grassAmount > grasses.length){
			while(grassTotal < params.grassAmount){
				addGrass();
				grassTotal++;
			}
		}

		if(params.grassAmount < grasses.length){
			while (grassTotal > params.grassAmount) {
				for(var i = grasses.length - 1; i >= params.grassAmount; i--){
					var removing = grasses[i];
					scene.remove(removing);
					grasses.pop();
					grassTotal--;
				}
			}
        }
	}

	//MOVE AROUND

	var moveForward = false;
	var moveLeft = false;
	var moveBackward = false;
	var moveRight = false;

	//when the user presses space they go first person
	const controls = new PointerLockControls( camera, document.body );

	const onKeyDown = function(event){
		switch(event.keyCode){
			case 32: //if space pressed
				controls.lock();
				camera.position.set(0,7,10);
				break;
			case 87: //w 
				moveForward = true; break;
			case 65: //a
				moveLeft = true; break;
			case 83: //s
				moveBackward = true; break;
			case 68: //d*/
				moveRight = true; break;
		}
	}

	const onKeyUp = function(event){
		switch(event.keyCode){
			case 87: //w 
				moveForward = false; break;
			case 65: //a
				moveLeft = false; break;
			case 83: //s
				moveBackward = false; break;
			case 68: //d*/
				moveRight = false; break;
		}
	}

	document.addEventListener( 'keydown', onKeyDown );
	document.addEventListener( 'keyup', onKeyUp );

	//const ambientLight = new THREE.AmbientLight(new THREE.Color(0.3,0.9,0.2), 0.7);
	//const ambientLight = new THREE.AmbientLight(new THREE.Color(0.5,0.5,0.5), 0.7);
	//scene.add(ambientLight); 	//globally illuminates all objects in scene

	//const directionalLight = new THREE.DirectionalLight( new THREE.Color(1,1,1), 0.4 );
	//scene.add( directionalLight ); 	//light emitted from top

	var day = true;
	var night = false;
	const sun = new THREE.DirectionalLight(0xFFF49E, 1);
	sun.position.set(50, 80, -50);

	const moon = new THREE.PointLight(0x4D7DDD, 0.5);
	moon.position.set(50, 80, 50);

	const ambientLight1 = new THREE.AmbientLight(new THREE.Color(0.5,0.5,0.5), 0.6);
	//scene.add(ambientLight);

	const ambientLight2 = new THREE.AmbientLight(new THREE.Color(0.5,0.5,0.5), 0.3);
	//scene.add(ambientLight);

	var count = 0;

	var theTime = function(){
		if(day){
			if(count == 1){
				count--;
				scene.remove(moon);
				scene.remove(ambientLight2);
			}
			scene.add(sun);
			scene.add(ambientLight1);
			count++;
		}
		if(night){
			if(count == 1){
				scene.remove(sun);
				scene.remove(ambientLight1);
				count--;
			}
			scene.add(ambientLight2);
			scene.add(moon);
			count++;
		}
		
	}

	//GUI
	//gui to adjust the garden layout
	const gui = new GUI();

	var params = {
		colour: 0xB6D7A8,
		grassAmount: 5,
		//fence: 'basic',
		time: 'day'
	};

	var gardencust = gui.addFolder('Garden Customisation');
	gardencust.addColor(params, 'colour').name("Garden Colour");
	gardencust.add(params, 'grassAmount', 0, 40, 5).name("Grass Total").onChange(function(value){
		grassRandomiser();
	});
	//gardencust.add(params,'fence', ['basic', 'rundown', 'mossy', 'none']).name("Fence");
	gardencust.add(params, 'time', ['day', 'night']).name("Time").onChange(function(value){
		if(value == 'day'){
			day = true;
			night = false;
		} else{
			night = true;
			day = false;
		}
	});

	
	var MyUpdateLoop = function ( )
      {
		basemat.color = new THREE.Color(params.colour);
		grassRandomiser();
		theTime();
        renderer.render(scene,camera);
        requestAnimationFrame(MyUpdateLoop);
      };

      requestAnimationFrame(MyUpdateLoop);

	  MyUpdateLoop();

	  function animate(){
		requestAnimationFrame(animate);

		if(controls.isLocked){
			if(moveForward){
				controls.moveForward(0.2);
			} else if (moveRight){
				controls.moveRight(0.2);
			} else if (moveBackward){
				controls.moveForward(-0.2);
			} else if (moveLeft){
				controls.moveRight(-0.2);
			}
		}

		renderer.render(scene, camera);
	  }
	  animate();

	//calling renderer
	renderer.render(scene,camera);
    </script>
  </body>
</html>
